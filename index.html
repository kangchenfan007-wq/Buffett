<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Buffett App"/>
<meta name="theme-color" content="#d97706"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="https://img.icons8.com/emoji/192/chart-increasing-emoji.png"/>
<title>Buffett Value Evaluator</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;-webkit-tap-highlight-color:transparent}
body{background:linear-gradient(135deg,#fffbeb,#fff7ed);min-height:100vh;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)}
.header{background:linear-gradient(135deg,#92400e,#d97706);color:white;padding:16px 16px 20px;padding-top:calc(16px + env(safe-area-inset-top))}
.header h1{font-size:20px;font-weight:800}
.header p{font-size:12px;color:#fde68a;margin-top:3px}
.search-row{display:flex;gap:8px;margin-top:12px}
.search-row input{flex:1;border:none;border-radius:12px;padding:12px 16px;font-size:16px;font-weight:700;font-family:monospace;color:#1f2937;outline:none;text-transform:uppercase;-webkit-appearance:none}
.search-row button{background:#1f2937;color:white;border:none;border-radius:12px;padding:12px 18px;font-size:18px;cursor:pointer}
.status-bar{font-size:11px;padding:5px 16px;text-align:center;background:#1e3a5f;color:#93c5fd}
.quota-bar{background:#1c1c1e;color:#fde68a;font-size:11px;padding:5px 16px;text-align:center}
.container{max-width:480px;margin:0 auto;padding:0 16px 100px}
.loading{text-align:center;padding:50px 20px}
.spinner{width:48px;height:48px;border:4px solid #fde68a;border-top-color:#d97706;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading p{color:#92400e;font-weight:600;font-size:14px;margin-top:8px}
.loading .step{font-size:12px;color:#9ca3af;margin-top:6px}
.error-box{background:#fef2f2;border:1px solid #fecaca;border-radius:14px;padding:20px;margin-top:16px;text-align:center}
.error-box h3{font-size:16px;color:#dc2626;margin-bottom:8px}
.error-box p{font-size:13px;color:#4b5563;line-height:1.6}
.card{background:white;border-radius:14px;border:1px solid #f3f4f6;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin-bottom:12px}
.company-header{background:white;border-radius:14px;border:1px solid #f3f4f6;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin:16px 0 12px}
.price-row{display:flex;justify-content:space-between;align-items:flex-start}
.up{color:#16a34a}.down{color:#dc2626}
.verdict-card{border-radius:16px;padding:24px;text-align:center;margin-bottom:12px}
.score-box{background:white;border-radius:10px;padding:8px 24px;display:inline-block;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.metric-box{background:white;border-radius:12px;border:1px solid #f3f4f6;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.05)}
.mlabel{font-size:10px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px}
.mvalue{font-size:18px;font-weight:800;color:#1f2937}
.msub{font-size:10px;color:#6b7280;margin-top:2px}
.result-section{background:white;border-radius:14px;border:1px solid #f3f4f6;padding:16px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.result-section h3{font-size:13px;font-weight:700;color:#374151;margin-bottom:8px;display:flex;justify-content:space-between;cursor:pointer;align-items:center}
.progress-bar{background:#f3f4f6;border-radius:99px;height:8px;margin-bottom:12px;overflow:hidden}
.progress-fill{height:100%;border-radius:99px;transition:width 0.7s ease}
.check-item{font-size:12px;color:#4b5563;display:flex;align-items:flex-start;gap:6px;margin-bottom:5px;line-height:1.4}
.check-ok{color:#22c55e;font-weight:700;flex-shrink:0}
.check-no{color:#f87171;font-weight:700;flex-shrink:0}
/* DCF */
.dcf-input-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.dcf-input-box{background:#f8fafc;border-radius:10px;padding:10px}
.dcf-input-box label{font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;display:block;margin-bottom:4px}
.dcf-input-box input{width:100%;border:1px solid #e2e8f0;border-radius:8px;padding:7px 10px;font-size:14px;font-weight:700;color:#1f2937;outline:none;background:white}
.dcf-calc-btn{width:100%;padding:11px;background:linear-gradient(135deg,#92400e,#d97706);color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;margin-top:4px;margin-bottom:12px}
.dcf-result-box{background:#fffbeb;border:1px solid #fde68a;border-radius:12px;padding:14px;margin-top:4px}
.dcf-result-box h4{font-size:12px;font-weight:700;color:#92400e;margin-bottom:10px;text-transform:uppercase}
.dcf-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #fde68a;font-size:12px}
.dcf-row:last-child{border-bottom:none;font-weight:700;font-size:13px;color:#92400e;padding-top:8px;margin-top:4px;border-top:2px solid #fde68a}
.dcf-formula{background:#fff7ed;border-radius:10px;padding:12px;margin-top:10px;font-size:11px;color:#92400e;line-height:1.8;font-family:monospace}
/* News */
.news-item{padding:12px 0;border-bottom:1px solid #f3f4f6}
.news-item:last-child{border-bottom:none}
.news-headline{font-size:13px;font-weight:600;color:#1f2937;line-height:1.4;margin-bottom:5px}
.news-meta{font-size:11px;color:#9ca3af;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.news-sentiment{font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px}
.sent-positive{background:#dcfce7;color:#16a34a}
.sent-negative{background:#fef2f2;color:#dc2626}
.sent-neutral{background:#f3f4f6;color:#6b7280}
/* Comparison */
.comp-table{width:100%;border-collapse:collapse;font-size:11px}
.comp-table th{background:#f8fafc;padding:7px 5px;text-align:center;font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;border-bottom:2px solid #e5e7eb}
.comp-table th:first-child{text-align:left}
.comp-table td{padding:7px 5px;border-bottom:1px solid #f3f4f6;text-align:center;color:#374151}
.comp-table td:first-child{text-align:left;font-weight:600;color:#6b7280}
.comp-table tr:last-child td{border-bottom:none}
.comp-highlight{background:#fffbeb}
.comp-best{color:#16a34a;font-weight:800}
.comp-worst{color:#dc2626}
.comp-badge{font-size:9px;font-weight:700;padding:1px 5px;border-radius:99px;background:#fef3c7;color:#d97706;margin-left:3px;vertical-align:middle}
/* AI Commentary */
.commentary-box{background:white;border-radius:14px;border:1px solid #f3f4f6;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
.commentary-section{margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid #f3f4f6}
.commentary-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.commentary-section h4{font-size:12px;font-weight:700;color:#374151;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em}
.commentary-section p{font-size:13px;color:#4b5563;line-height:1.7}
.rating-pill{display:inline-block;font-size:11px;font-weight:700;padding:3px 10px;border-radius:99px;margin-left:8px;vertical-align:middle}
.rating-strong{background:#dcfce7;color:#16a34a}
.rating-moderate{background:#fef3c7;color:#d97706}
.rating-weak{background:#fef2f2;color:#dc2626}
/* Quote */
.quote-box{background:#fffbeb;border:1px solid #fde68a;border-radius:14px;padding:16px;margin-bottom:12px;text-align:center}
.quote-box p{font-size:12px;color:#92400e;font-style:italic;line-height:1.6}
.quote-box span{font-size:11px;color:#d97706;margin-top:6px;display:block}
.btn-save{width:100%;padding:14px;background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:white;border:none;border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:8px}
.btn-reset{width:100%;padding:14px;background:white;border:1.5px solid #e5e7eb;color:#4b5563;border-radius:14px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:12px}
.watchlist-card{background:white;border-radius:14px;border:1px solid #f3f4f6;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin-bottom:16px}
.watchlist-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f3f4f6}
.watchlist-item:last-child{border-bottom:none}
.disclaimer{font-size:10px;color:#9ca3af;text-align:center;padding:8px 0 16px;line-height:1.5}
.welcome{text-align:center;padding:40px 20px 20px}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid #f3f4f6;padding:8px 0;padding-bottom:calc(8px + env(safe-area-inset-bottom));display:flex;justify-content:space-around;box-shadow:0 -2px 10px rgba(0,0,0,0.08);z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;padding:4px 0}
.nav-btn span:first-child{font-size:22px}
.nav-btn span:last-child{font-size:10px;font-weight:600;color:#9ca3af}
.nav-btn.active span:last-child{color:#d97706}
.page{display:none}.page.active{display:block}
.collapse-content{display:none}.collapse-content.open{display:block}
.chevron{font-size:10px;color:#9ca3af;transition:transform 0.2s}
.chevron.open{transform:rotate(180deg)}
</style>
</head>
<body>

<div class="header">
  <h1>üßì Buffett Evaluator</h1>
  <p>Real-time value investing analysis</p>
  <div class="search-row">
    <input type="text" id="tickerInput" placeholder="AAPL, INTC, KO..." maxlength="10" autocomplete="off" autocorrect="off" spellcheck="false"/>
    <button onclick="analyzeStock()">üîç</button>
  </div>
</div>

<div class="status-bar" id="statusBar">üü¢ Ready ‚Äî Enter a US stock ticker</div>
<div class="quota-bar" id="quotaBar">üìä Loading...</div>

<div class="container">
  <div class="page active" id="page-analyze">
    <div id="results">
      <div class="welcome">
        <div style="font-size:56px;margin-bottom:12px">üìà</div>
        <div style="font-size:17px;font-weight:700;color:#374151;margin-bottom:8px">Ready to Analyze</div>
        <div style="font-size:13px;color:#6b7280;line-height:2.2"><strong>AAPL</strong> ¬∑ <strong>INTC</strong> ¬∑ <strong>MSFT</strong> ¬∑ <strong>KO</strong> ¬∑ <strong>JNJ</strong></div>
        <div style="margin-top:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:14px;text-align:left;font-size:12px;color:#166534;line-height:1.9">
          ‚ú® <strong>Features:</strong><br/>
          üßÆ Editable DCF calculator<br/>
          üì∞ Company-specific news & sentiment<br/>
          üìä Smart competitor comparison<br/>
          ü§ñ AI commentary on future outlook
        </div>
      </div>
    </div>
  </div>

  <div class="page" id="page-watchlist">
    <div style="padding-top:16px" id="watchlistView"></div>
  </div>

  <div class="page" id="page-settings">
    <div style="padding-top:16px">
      <div class="watchlist-card">
        <div style="font-size:15px;font-weight:700;color:#374151;margin-bottom:16px">‚öôÔ∏è Settings</div>
        <div style="font-size:13px;font-weight:600;color:#4b5563;margin-bottom:6px">Alpha Vantage API Key</div>
        <input id="apiKeyInput" type="text" placeholder="Paste your API key"
          style="width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:13px;font-family:monospace;outline:none;margin-bottom:10px"/>
        <button onclick="saveApiKey()" style="width:100%;padding:11px;background:#d97706;color:white;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer">üíæ Save Key</button>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid #f3f4f6">
          <div style="font-size:13px;font-weight:600;color:#4b5563;margin-bottom:6px">Usage Today</div>
          <div id="settingsQuota" style="font-size:13px;color:#6b7280"></div>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid #f3f4f6;font-size:12px;color:#6b7280;line-height:1.8">
          üí° Free tier: 25 calls/day<br/>
          Get extra key: <strong style="color:#d97706">alphavantage.co/support/#api-key</strong>
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid #f3f4f6">
          <button onclick="clearWatchlist()" style="width:100%;padding:11px;background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer">üóëÔ∏è Clear Watchlist</button>
        </div>
      </div>
      <div class="watchlist-card">
        <div style="font-size:15px;font-weight:700;color:#374151;margin-bottom:10px">üì± Install on iPhone</div>
        <div style="font-size:13px;color:#4b5563;line-height:1.9">1. Open in <strong>Safari</strong><br/>2. Tap <strong>Share ‚Üë</strong><br/>3. Tap <strong>"Add to Home Screen"</strong><br/>4. Tap <strong>"Add"</strong> ‚úÖ</div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-nav">
  <button class="nav-btn active" id="nav-analyze" onclick="showPage('analyze')"><span>üîç</span><span>Analyze</span></button>
  <button class="nav-btn" id="nav-watchlist" onclick="showPage('watchlist')"><span>üìã</span><span>Watchlist</span></button>
  <button class="nav-btn" id="nav-settings" onclick="showPage('settings')"><span>‚öôÔ∏è</span><span>Settings</span></button>
</div>

<script>
let AV_KEY = localStorage.getItem('av_key') || '8CWC4MJFBVMYX2FN';
let watchlist = [];
let callsToday = 0;
let currentOvData = null;
let currentTicker = '';

// ‚îÄ‚îÄ Smart competitor map by ticker ‚îÄ‚îÄ
const TICKER_COMPETITORS = {
  // Semiconductors
  'INTC':['TSM','AMD','NVDA'],'AMD':['INTC','NVDA','TSM'],'NVDA':['AMD','INTC','TSM'],
  'TSM':['INTC','ASML','AMAT'],'QCOM':['AVGO','MRVL','AMD'],'AVGO':['QCOM','TXN','ADI'],
  // Big Tech
  'AAPL':['MSFT','GOOGL','META'],'MSFT':['AAPL','GOOGL','AMZN'],
  'GOOGL':['META','MSFT','AMZN'],'META':['GOOGL','SNAP','PINS'],
  'AMZN':['MSFT','GOOGL','BABA'],'TSLA':['GM','F','BYD'],
  'NFLX':['DIS','PARA','WBD'],
  // Finance
  'JPM':['BAC','WFC','GS'],'BAC':['JPM','WFC','C'],'GS':['MS','JPM','BLK'],
  'V':['MA','AXP','PYPL'],'MA':['V','AXP','PYPL'],
  // Consumer
  'KO':['PEP','MNST','KDRFY'],'PEP':['KO','MNST','MDLZ'],
  'MCD':['YUM','QSR','SBUX'],'SBUX':['MCD','DNKN','QSR'],
  'WMT':['COST','TGT','AMZN'],'COST':['WMT','TGT','BJ'],
  // Healthcare
  'JNJ':['PFE','MRK','ABT'],'PFE':['JNJ','MRK','ABBV'],
  'UNH':['CVS','CI','HUM'],
  // Energy
  'XOM':['CVX','COP','BP'],'CVX':['XOM','COP','SLB'],
  // Industrial
  'BA':['LMT','RTX','NOC'],'CAT':['DE','AGCO','CNH'],
};

// Sector fallback
const SECTOR_COMPETITORS = {
  'Technology':['AAPL','MSFT','GOOGL'],'Semiconductors':['NVDA','AMD','INTC'],
  'Consumer Staples':['KO','PEP','PG'],'Consumer Discretionary':['AMZN','TGT','HD'],
  'Health Care':['JNJ','PFE','MRK'],'Financials':['JPM','BAC','GS'],
  'Energy':['XOM','CVX','COP'],'Industrials':['BA','CAT','GE'],
  'Communication Services':['GOOGL','META','NFLX'],
};

try {
  watchlist = JSON.parse(localStorage.getItem('buffett_wl')||'[]');
  const today = new Date().toDateString();
  const saved = JSON.parse(localStorage.getItem('av_quota')||'{"date":"","calls":0}');
  callsToday = saved.date===today ? saved.calls : 0;
} catch(e){}

if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});

function saveQuota(){
  localStorage.setItem('av_quota',JSON.stringify({date:new Date().toDateString(),calls:callsToday}));
  const rem=25-callsToday;
  document.getElementById('quotaBar').textContent=`üìä API calls: ${callsToday}/25  (${rem} remaining today)`;
  const sq=document.getElementById('settingsQuota');
  if(sq) sq.textContent=`${callsToday} used ¬∑ ${rem} remaining`;
}
saveQuota();

function setStatus(msg,color='#93c5fd'){
  const b=document.getElementById('statusBar');
  b.textContent=msg; b.style.color=color;
}

function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if(name==='watchlist') renderWatchlist();
  if(name==='settings'){document.getElementById('apiKeyInput').value=AV_KEY; saveQuota();}
}

function saveApiKey(){
  AV_KEY=document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('av_key',AV_KEY);
  alert('‚úÖ API key saved!');
}

function clearWatchlist(){
  if(confirm('Clear all watchlist stocks?')){
    watchlist=[];
    localStorage.setItem('buffett_wl','[]');
    renderWatchlist();
  }
}

document.getElementById('tickerInput').addEventListener('keypress',e=>{
  if(e.key==='Enter') analyzeStock();
});

function toggleSection(id){
  const el=document.getElementById('cc-'+id);
  const ch=document.getElementById('ch-'+id);
  if(!el) return;
  el.classList.toggle('open');
  if(ch) ch.classList.toggle('open');
}

async function avFetch(fn,params){
  const url=`https://www.alphavantage.co/query?function=${fn}&${params}&apikey=${AV_KEY}`;
  const res=await fetch(url);
  if(!res.ok) throw new Error(`Network error ${res.status}`);
  const data=await res.json();
  if(data['Note']) throw new Error('Rate limit. Wait 1 min and retry.');
  if(data['Information']) throw new Error('Daily limit reached (25/day). Come back tomorrow!');
  return data;
}

function n(v){return parseFloat(v)||0;}

// ‚îÄ‚îÄ Recalculate DCF with custom inputs ‚îÄ‚îÄ
function recalcDCF(){
  const eps    = parseFloat(document.getElementById('dcf_eps').value)||0;
  const growth = parseFloat(document.getElementById('dcf_growth').value)/100||0.08;
  const term   = parseFloat(document.getElementById('dcf_term').value)/100||0.03;
  const disc   = parseFloat(document.getElementById('dcf_disc').value)/100||0.10;
  const yrs    = parseInt(document.getElementById('dcf_yrs').value)||10;
  const price  = parseFloat(document.getElementById('dcf_price').value)||0;

  let iv=0;
  const rows=[];
  if(eps>0){
    let cf=eps, pvSum=0;
    for(let i=1;i<=yrs;i++){
      cf*=(1+growth);
      const pv=cf/Math.pow(1+disc,i);
      pvSum+=pv;
      if(i<=5||i===yrs) rows.push(`Yr ${i}: EPS=$${cf.toFixed(2)} ‚Üí PV=$${pv.toFixed(2)}`);
      if(i===6&&yrs>7) rows.push('...');
    }
    const tv=(cf*(1+term))/(disc-term);
    const pvt=tv/Math.pow(1+disc,yrs);
    iv=pvSum+pvt;
    rows.push(`Terminal Value ‚Üí PV=$${pvt.toFixed(2)}`);
  }

  const mos = price>0&&iv>0 ? ((iv-price)/iv)*100 : null;

  document.getElementById('dcf-result-area').innerHTML=`
    <div class="dcf-result-box">
      <h4>üìê DCF Results</h4>
      <div class="dcf-row"><span style="color:#6b7280">Intrinsic Value</span><span style="color:#16a34a;font-weight:800;font-size:15px">$${iv.toFixed(2)}</span></div>
      ${price>0?`<div class="dcf-row"><span style="color:#6b7280">Current Price</span><span>$${price.toFixed(2)}</span></div>`:''}
      ${mos!==null?`<div class="dcf-row"><span style="color:#6b7280">Margin of Safety</span><span style="font-weight:700;color:${mos>=30?'#16a34a':mos>=0?'#d97706':'#dc2626'}">${mos.toFixed(1)}%</span></div>`:''}
      <div class="dcf-row"><span style="color:#6b7280">Verdict</span><span style="font-weight:800;color:${mos===null?'#9ca3af':mos>=30?'#16a34a':mos>=0?'#d97706':'#dc2626'}">${mos===null?'N/A':mos>=30?'üü¢ Buy Zone':mos>=10?'üü° Fair Value':mos>=0?'üü° Slightly Overvalued':'üî¥ Overvalued'}</span></div>
    </div>
    <div class="dcf-formula">
      <strong>Formula:</strong> IV = Œ£[EPS√ó(1+g)‚Åø/(1+r)‚Åø] + Terminal Value/(1+r)‚Åø<br/><br/>
      <strong>Year-by-year breakdown:</strong><br/>
      ${rows.join('<br/>')}
    </div>`;
}

// ‚îÄ‚îÄ Generate AI Commentary ‚îÄ‚îÄ
function generateCommentary(ticker, ov, compDataArr){
  const name      = ov['Name']||ticker;
  const sector    = ov['Sector']||'';
  const industry  = ov['Industry']||'';
  const roe       = n(ov['ReturnOnEquityTTM'])*100;
  const netMargin = n(ov['ProfitMargin'])*100;
  const opMargin  = n(ov['OperatingMarginTTM'])*100;
  const revGrowth = n(ov['QuarterlyRevenueGrowthYOY'])*100;
  const earningsG = n(ov['QuarterlyEarningsGrowthYOY'])*100;
  const debtToEq  = n(ov['DebtToEquity'])/100;
  const pegRatio  = n(ov['PEGRatio']);
  const peRatio   = n(ov['PERatio']);
  const beta      = n(ov['Beta']);
  const divYield  = n(ov['DividendYield'])*100;
  const roa       = n(ov['ReturnOnAssetsTTM'])*100;
  const eps       = n(ov['EPS']);
  const forwardPE = n(ov['ForwardPE']);

  // Compare ROE vs competitors
  const compROEs  = compDataArr.map(c=>n(c.data['ReturnOnEquityTTM'])*100);
  const avgCompROE= compROEs.length>0 ? compROEs.reduce((a,b)=>a+b,0)/compROEs.length : 0;
  const compNames = compDataArr.map(c=>c.ticker).join(', ');
  const compPEs   = compDataArr.map(c=>n(c.data['PERatio'])).filter(v=>v>0);
  const avgCompPE = compPEs.length>0 ? compPEs.reduce((a,b)=>a+b,0)/compPEs.length : 0;
  const compMargins=compDataArr.map(c=>n(c.data['ProfitMargin'])*100);
  const avgCompMargin=compMargins.length>0?compMargins.reduce((a,b)=>a+b,0)/compMargins.length:0;

  // ‚îÄ‚îÄ Future Trend ‚îÄ‚îÄ
  let trendRating, trendText;
  if(revGrowth>15&&earningsG>15){
    trendRating='strong'; trendText=`${name} shows strong momentum with ${revGrowth.toFixed(1)}% revenue growth and ${earningsG.toFixed(1)}% earnings growth YoY, significantly above industry average. This trajectory suggests continued market share expansion and pricing power. ${sector==='Technology'?'The ongoing AI and digital transformation tailwinds provide additional runway for growth.':sector==='Health Care'?'Demographics and innovation cycles support sustained demand.':''} Compared to ${compNames}, ${name} ${revGrowth>15?'is growing faster':'maintains competitive growth'}, making it well-positioned for the next 3‚Äì5 years.`;
  } else if(revGrowth>5||earningsG>5){
    trendRating='moderate'; trendText=`${name} shows moderate growth with ${revGrowth.toFixed(1)}% revenue growth YoY. While not explosive, this steady trajectory indicates a stable business. Compared to peers (${compNames}), the company maintains a competitive but not leading position. Investors should monitor whether growth accelerates or decelerates over the next 2‚Äì3 quarters.`;
  } else {
    trendRating='weak'; trendText=`${name}'s growth trajectory shows signs of slowing ‚Äî revenue growth of ${revGrowth.toFixed(1)}% and earnings growth of ${earningsG.toFixed(1)}% lag behind competitive expectations. Compared to ${compNames}, the company faces headwinds that could pressure future returns. This warrants caution unless management demonstrates a credible turnaround strategy.`;
  }

  // ‚îÄ‚îÄ Management Competence ‚îÄ‚îÄ
  let mgmtRating, mgmtText;
  const mgmtScore=(roe>=15?1:0)+(roa>=5?1:0)+(opMargin>=15?1:0)+(debtToEq<0.5?1:0);
  if(mgmtScore>=3){
    mgmtRating='strong'; mgmtText=`Management at ${name} demonstrates strong capital allocation with ROE of ${roe.toFixed(1)}% (vs peer average ${avgCompROE.toFixed(1)}%) and operating margin of ${opMargin.toFixed(1)}%. ${debtToEq<0.5?`The conservative debt/equity ratio of ${debtToEq.toFixed(2)} shows disciplined financial management.`:`Debt levels are manageable.`} ROA of ${roa.toFixed(1)}% indicates efficient use of assets ‚Äî a key Buffett criterion for identifying excellent management teams.`;
  } else if(mgmtScore>=2){
    mgmtRating='moderate'; mgmtText=`${name}'s management shows mixed results. ROE of ${roe.toFixed(1)}% and operating margin of ${opMargin.toFixed(1)}% are ${roe>=15&&opMargin>=15?'both solid':'inconsistent'} compared to peers (${compNames}). ${debtToEq>1?`The debt/equity ratio of ${debtToEq.toFixed(2)} warrants monitoring.`:'Balance sheet management appears reasonable.'} Investors should look for consistent improvement in capital efficiency over the next 2‚Äì3 years.`;
  } else {
    mgmtRating='weak'; mgmtText=`Management efficiency metrics at ${name} raise concerns ‚Äî ROE of ${roe.toFixed(1)}% and ROA of ${roa.toFixed(1)}% trail the peer average. Operating margin of ${opMargin.toFixed(1)}% suggests possible cost structure challenges. Buffett would likely scrutinize whether current leadership has a credible plan to improve returns on capital relative to competitors like ${compNames}.`;
  }

  // ‚îÄ‚îÄ Competitive Position ‚îÄ‚îÄ
  let compRating, compText;
  const marginBetter = netMargin > avgCompMargin;
  const roeBetter    = roe > avgCompROE;
  const valuationBetter = avgCompPE>0 && peRatio<avgCompPE;
  const compScore=(marginBetter?1:0)+(roeBetter?1:0)+(valuationBetter?1:0);
  if(compScore>=2){
    compRating='strong'; compText=`${name} holds a competitive advantage over ${compNames}. ${marginBetter?`Its net margin of ${netMargin.toFixed(1)}% exceeds the peer average of ${avgCompMargin.toFixed(1)}%, indicating superior pricing power or cost efficiency.`:''} ${roeBetter?`ROE of ${roe.toFixed(1)}% outperforms the competitive average of ${avgCompROE.toFixed(1)}%.`:''} ${valuationBetter?`Relative valuation at P/E ${peRatio.toFixed(1)}x is more attractive than the peer average of ${avgCompPE.toFixed(1)}x.`:''} This combination aligns with Buffett's focus on businesses with durable moats.`;
  } else if(compScore===1){
    compRating='moderate'; compText=`${name} is competitively positioned but not dominant versus ${compNames}. Net margin of ${netMargin.toFixed(1)}% is ${marginBetter?'above':'below'} peer average of ${avgCompMargin.toFixed(1)}%. The company has some competitive strengths but also faces meaningful competition that could limit pricing power and margin expansion.`;
  } else {
    compRating='weak'; compText=`${name} appears to be in a weaker competitive position relative to ${compNames}. Net margin of ${netMargin.toFixed(1)}% trails the peer average of ${avgCompMargin.toFixed(1)}%, suggesting limited pricing power. Buffett would question whether the company has a durable moat to protect long-term returns. Investors should assess whether competitive pressures are structural or temporary.`;
  }

  // ‚îÄ‚îÄ Buffett Verdict ‚îÄ‚îÄ
  const overallScore = (trendRating==='strong'?3:trendRating==='moderate'?2:1)
    +(mgmtRating==='strong'?3:mgmtRating==='moderate'?2:1)
    +(compRating==='strong'?3:compRating==='moderate'?2:1);

  let buffettVerdict;
  if(overallScore>=8){
    buffettVerdict=`${name} exhibits many qualities Buffett looks for ‚Äî strong growth, excellent management, and competitive advantages. ${pegRatio>0&&pegRatio<1?`The PEG ratio of ${pegRatio.toFixed(2)} suggests the stock may be undervalued relative to its growth.`:''} ${divYield>0?`The ${divYield.toFixed(2)}% dividend yield adds to total return.`:''} This appears to be the type of "wonderful company at a fair price" Buffett describes.`;
  } else if(overallScore>=6){
    buffettVerdict=`${name} is a decent business with some attractive qualities but also notable weaknesses. Buffett would likely want to see improvement in ${roe<15?'return on equity ':''} ${netMargin<10?'profit margins ':''} before considering it a "wonderful company." It may be suitable for patient investors willing to wait for business improvement or a better entry price.`;
  } else {
    buffettVerdict=`Based on Buffett's criteria, ${name} currently faces too many challenges ‚Äî ${revGrowth<5?'slowing growth, ':''} ${roe<15?'below-target returns, ':''} ${debtToEq>1?'elevated debt ':''} ‚Äî to qualify as a strong value investment. Buffett would likely "put it in the too-hard pile" and look for better opportunities among its competitors.`;
  }

  const ratingHtml = r=>`<span class="rating-pill ${r==='strong'?'rating-strong':r==='moderate'?'rating-moderate':'rating-weak'}">${r==='strong'?'‚úÖ Strong':r==='moderate'?'‚ö†Ô∏è Moderate':'‚ùå Weak'}</span>`;

  return `
    <div class="commentary-section">
      <h4>üìà Future Trend ${ratingHtml(trendRating)}</h4>
      <p>${trendText}</p>
    </div>
    <div class="commentary-section">
      <h4>üëî Management Competence ${ratingHtml(mgmtRating)}</h4>
      <p>${mgmtText}</p>
    </div>
    <div class="commentary-section">
      <h4>üèÜ Competitive Position ${ratingHtml(compRating)}</h4>
      <p>${compText}</p>
    </div>
    <div class="commentary-section">
      <h4>üßì Buffett's Verdict</h4>
      <p>${buffettVerdict}</p>
    </div>`;
}

async function analyzeStock(){
  const ticker=document.getElementById('tickerInput').value.trim().toUpperCase();
  if(!ticker){alert('Please enter a ticker');return;}
  if(callsToday>=22){
    document.getElementById('results').innerHTML=`<div class="error-box" style="margin-top:16px">
      <h3>‚è∞ API Limit Low</h3><p>Only ${25-callsToday} calls left today. Come back tomorrow or add a new key in Settings.</p></div>`;
    return;
  }

  showPage('analyze');
  currentTicker=ticker;
  const results=document.getElementById('results');
  results.innerHTML=`<div class="loading"><div class="spinner"></div>
    <p>Analyzing <strong>${ticker}</strong></p>
    <div class="step" id="loadStep">Fetching overview...</div></div>`;
  setStatus(`‚è≥ Analyzing ${ticker}...`,'#fde68a');

  function setStep(msg){const s=document.getElementById('loadStep');if(s)s.textContent=msg;}

  try{
    // ‚îÄ‚îÄ Call 1: Main overview ‚îÄ‚îÄ
    setStep('üìä Company overview (1/4)...');
    const ov=await avFetch('OVERVIEW',`symbol=${ticker}`);
    callsToday++; saveQuota();
    if(!ov['Name']) throw new Error(`"${ticker}" not found. Try AAPL, INTC, MSFT, KO`);
    currentOvData=ov;

    // ‚îÄ‚îÄ Call 2: News ‚îÄ‚îÄ
    setStep('üì∞ Latest news (2/4)...');
    let newsItems=[];
    try{
      const nd=await avFetch('NEWS_SENTIMENT',`tickers=${ticker}&limit=6&sort=LATEST`);
      callsToday++; saveQuota();
      newsItems=(nd?.feed||[]).filter(item=>{
        // Only show news that mentions this ticker specifically
        const tickers=(item.ticker_sentiment||[]).map(t=>t.ticker);
        return tickers.includes(ticker)||item.title?.toUpperCase().includes(ticker);
      }).slice(0,5);
      if(newsItems.length===0) newsItems=(nd?.feed||[]).slice(0,4);
    }catch(e){}

    // ‚îÄ‚îÄ Get competitors ‚îÄ‚îÄ
    const sector=ov['Sector']||'Technology';
    const compTickers=(TICKER_COMPETITORS[ticker]||SECTOR_COMPETITORS[sector]||['AAPL','MSFT','GOOGL']).filter(t=>t!==ticker).slice(0,2);

    // ‚îÄ‚îÄ Call 3 & 4: Competitor overviews ‚îÄ‚îÄ
    let compData=[];
    for(let i=0;i<compTickers.length;i++){
      if(callsToday>=24) break;
      setStep(`üìä Competitor ${compTickers[i]} (${3+i}/4)...`);
      try{
        const cd=await avFetch('OVERVIEW',`symbol=${compTickers[i]}`);
        callsToday++; saveQuota();
        if(cd['Name']) compData.push({ticker:compTickers[i],data:cd});
      }catch(e){}
    }

    setStep('üßÆ Calculating...');

    // ‚îÄ‚îÄ Parse data ‚îÄ‚îÄ
    const companyName = ov['Name']||ticker;
    const sector2     = ov['Sector']||'';
    const industry    = ov['Industry']||'';
    const mktCap      = n(ov['MarketCapitalization']);
    const eps         = n(ov['EPS']);
    const peRatio     = n(ov['PERatio']);
    const forwardPE   = n(ov['ForwardPE']);
    const pegRatio    = n(ov['PEGRatio']);
    const pbRatio     = n(ov['PriceToBookRatio']);
    const pSales      = n(ov['PriceToSalesRatioTTM']);
    const divYield    = n(ov['DividendYield'])*100;
    const roe         = n(ov['ReturnOnEquityTTM'])*100;
    const roa         = n(ov['ReturnOnAssetsTTM'])*100;
    const netMargin   = n(ov['ProfitMargin'])*100;
    const opMargin    = n(ov['OperatingMarginTTM'])*100;
    const revGrowth   = n(ov['QuarterlyRevenueGrowthYOY'])*100;
    const earningsG   = n(ov['QuarterlyEarningsGrowthYOY'])*100;
    const analystTgt  = n(ov['AnalystTargetPrice']);
    const beta        = n(ov['Beta']);
    const week52High  = n(ov['52WeekHigh']);
    const week52Low   = n(ov['52WeekLow']);
    const bookValue   = n(ov['BookValue']);
    const evEbitda    = n(ov['EVToEBITDA']);
    const debtToEq    = n(ov['DebtToEquity'])/100;
    const currentR    = n(ov['CurrentRatio']);

    // Estimate current price
    const estPrice = analystTgt>0 ? analystTgt*0.95 : pbRatio>0&&bookValue>0 ? pbRatio*bookValue : 0;

    // ‚îÄ‚îÄ Default DCF ‚îÄ‚îÄ
    const g   = Math.min(Math.max(earningsG>0?earningsG/100:revGrowth>0?revGrowth/100:0.08,0.03),0.25);
    const dr  = 0.10, tg=0.03, yrs=10;
    let iv=0;
    if(eps>0){
      let cf=eps;
      for(let i=1;i<=yrs;i++){cf*=(1+g);iv+=cf/Math.pow(1+dr,i);}
      iv+=(cf*(1+tg)/(dr-tg))/Math.pow(1+dr,yrs);
    }
    const mos=estPrice>0&&iv>0?((iv-estPrice)/iv)*100:null;

    // ‚îÄ‚îÄ Scores ‚îÄ‚îÄ
    const dcfScore=mos===null?0:mos>=30?25:mos>=10?18:mos>=0?10:0;
    const dcfItems=[
      {ok:iv>0,             text:`Intrinsic Value: $${iv.toFixed(2)}/share`},
      {ok:mos!==null&&mos>=30,text:mos!==null?`Margin of Safety: ${mos.toFixed(1)}% (target ‚â•30%)`:'Margin of Safety: N/A'},
      {ok:g>=0.08&&g<=0.20, text:`Growth Rate: ${(g*100).toFixed(1)}% (ideal 8‚Äì20%)`},
      {ok:analystTgt>0,     text:analystTgt>0?`Analyst Target: $${analystTgt.toFixed(2)}`:'Analyst Target: N/A'},
    ];
    const epsOk=eps>0,peOk=peRatio>0&&peRatio<25,pegOk=pegRatio>0&&pegRatio<1,pbOk=pbRatio>0&&pbRatio<3;
    const epsScore=(epsOk?4:0)+(peOk?3:0)+(pegOk?4:0)+(pbOk?2:0);
    const epsItems=[
      {ok:epsOk,text:`EPS (TTM): $${eps.toFixed(2)}`},
      {ok:peOk, text:`P/E: ${peRatio>0?peRatio.toFixed(1):'N/A'} (target <25)`},
      {ok:pegOk,text:`PEG: ${pegRatio>0?pegRatio.toFixed(2):'N/A'} (under 1.0 = undervalued)`},
      {ok:pbOk, text:`P/B: ${pbRatio>0?pbRatio.toFixed(2):'N/A'} (under 3.0)`},
    ];
    const moatItems=[
      {ok:roe>=15,      text:`ROE: ${roe.toFixed(1)}% (target ‚â•15%)`},
      {ok:netMargin>=10,text:`Net Margin: ${netMargin.toFixed(1)}% (target ‚â•10%)`},
      {ok:opMargin>=15, text:`Op Margin: ${opMargin.toFixed(1)}% (target ‚â•15%)`},
      {ok:revGrowth>=5, text:`Revenue Growth: ${revGrowth.toFixed(1)}% YoY (target ‚â•5%)`},
    ];
    const moatScore=moatItems.filter(i=>i.ok).length*6;
    const debtItems=[
      {ok:debtToEq>0&&debtToEq<0.5, text:debtToEq>0?`Debt/Equity: ${debtToEq.toFixed(2)} (target <0.5)`:'Debt/Equity: N/A'},
      {ok:currentR>=1.5,            text:currentR>0?`Current Ratio: ${currentR.toFixed(2)} (target ‚â•1.5)`:'Current Ratio: N/A'},
      {ok:roa>=5,                   text:`ROA: ${roa.toFixed(1)}% (target ‚â•5%)`},
      {ok:evEbitda>0&&evEbitda<15,  text:evEbitda>0?`EV/EBITDA: ${evEbitda.toFixed(1)} (under 15)`:'EV/EBITDA: N/A'},
    ];
    const debtScore=debtItems.filter(i=>i.ok).length*6;
    const oeItems=[
      {ok:netMargin>0,        text:`Net Margin: ${netMargin.toFixed(1)}%`},
      {ok:roe>=15,            text:`ROE ${roe.toFixed(1)}% = strong owner earnings`},
      {ok:pSales>0&&pSales<3, text:pSales>0?`P/Sales: ${pSales.toFixed(2)} (under 3.0)`:'P/Sales: N/A'},
      {ok:divYield>0,         text:divYield>0?`Dividend: ${divYield.toFixed(2)}% yield`:'No dividend'},
    ];
    const oeScore=oeItems.filter(i=>i.ok).length*6;
    const total=dcfScore+epsScore+moatScore+debtScore+oeScore;
    const maxScore=26+13+24+24+24;
    const verdict=total>=65
      ?{label:'Strong Buy',color:'#16a34a',bg:'#f0fdf4',border:'#bbf7d0',emoji:'üü¢'}
      :total>=45
      ?{label:'Watch List',color:'#d97706',bg:'#fffbeb',border:'#fde68a',emoji:'üü°'}
      :{label:'Avoid',     color:'#dc2626',bg:'#fef2f2',border:'#fecaca',emoji:'üî¥'};

    // ‚îÄ‚îÄ News HTML ‚îÄ‚îÄ
    const newsHtml=newsItems.length>0?newsItems.map(item=>{
      const sl=item.overall_sentiment_label||'Neutral';
      const sc=sl.toLowerCase().includes('bull')||sl.toLowerCase().includes('positive')?'sent-positive'
        :sl.toLowerCase().includes('bear')||sl.toLowerCase().includes('negative')?'sent-negative':'sent-neutral';
      const tp=item.time_published||'';
      const dt=tp.length>=8?`${tp.substring(0,4)}-${tp.substring(4,6)}-${tp.substring(6,8)}`:'';
      const tickerSent=(item.ticker_sentiment||[]).find(t=>t.ticker===ticker);
      const tickerScore=tickerSent?parseFloat(tickerSent.ticker_sentiment_score||0):null;
      const tickerLabel=tickerScore!==null?(tickerScore>0.15?'üìà Bullish for '+ticker:tickerScore<-0.15?'üìâ Bearish for '+ticker:'‚û°Ô∏è Neutral for '+ticker):'';
      return `<div class="news-item">
        <div class="news-headline">${item.title||'No title'}</div>
        <div class="news-meta">
          <span class="news-sentiment ${sc}">${sl}</span>
          ${tickerLabel?`<span style="font-size:10px;font-weight:600;color:#374151">${tickerLabel}</span>`:''}
          <span>${item.source||''}</span>
          <span>${dt}</span>
        </div>
      </div>`;
    }).join(''):'<div style="font-size:13px;color:#9ca3af;padding:12px 0;text-align:center">No recent news available</div>';

    // ‚îÄ‚îÄ Competitor Table ‚îÄ‚îÄ
    const allStocks=[{ticker,data:ov},...compData];
    const metrics=[
      {key:'PERatio',          label:'P/E',        fmt:v=>n(v)>0?n(v).toFixed(1):'N/A',better:'lower'},
      {key:'ForwardPE',        label:'Fwd P/E',    fmt:v=>n(v)>0?n(v).toFixed(1):'N/A',better:'lower'},
      {key:'PEGRatio',         label:'PEG',        fmt:v=>n(v)>0?n(v).toFixed(2):'N/A',better:'lower'},
      {key:'PriceToBookRatio', label:'P/B',        fmt:v=>n(v)>0?n(v).toFixed(2):'N/A',better:'lower'},
      {key:'ProfitMargin',     label:'Net Margin', fmt:v=>(n(v)*100).toFixed(1)+'%',    better:'higher'},
      {key:'OperatingMarginTTM',label:'Op Margin', fmt:v=>(n(v)*100).toFixed(1)+'%',    better:'higher'},
      {key:'ReturnOnEquityTTM',label:'ROE',        fmt:v=>(n(v)*100).toFixed(1)+'%',    better:'higher'},
      {key:'ReturnOnAssetsTTM',label:'ROA',        fmt:v=>(n(v)*100).toFixed(1)+'%',    better:'higher'},
      {key:'EPS',              label:'EPS',        fmt:v=>'$'+n(v).toFixed(2),          better:'higher'},
      {key:'QuarterlyRevenueGrowthYOY',label:'Rev Growth',fmt:v=>(n(v)*100).toFixed(1)+'%',better:'higher'},
      {key:'DividendYield',    label:'Dividend',   fmt:v=>(n(v)*100).toFixed(2)+'%',    better:'higher'},
      {key:'DebtToEquity',     label:'Debt/Eq',    fmt:v=>n(v)>0?(n(v)/100).toFixed(2):'N/A',better:'lower'},
      {key:'Beta',             label:'Beta',       fmt:v=>n(v)>0?n(v).toFixed(2):'N/A',better:'lower'},
    ];

    function getBestIdx(key,better){
      const vals=allStocks.map(s=>n(s.data[key]));
      const valid=vals.filter(v=>v>0);
      if(!valid.length) return -1;
      const best=better==='lower'?Math.min(...valid):Math.max(...valid);
      return vals.findIndex(v=>v===best);
    }

    const compTableHtml=`<div style="overflow-x:auto">
      <table class="comp-table">
        <thead><tr>
          <th>Metric</th>
          ${allStocks.map((s,i)=>`<th style="${i===0?'color:#d97706':''}">
            ${s.ticker}${i===0?'<span class="comp-badge">‚òÖ</span>':''}
          </th>`).join('')}
        </tr></thead>
        <tbody>
          ${metrics.map(m=>{
            const bi=getBestIdx(m.key,m.better);
            return `<tr>${['',].concat([]).join('')}
              <td>${m.label}</td>
              ${allStocks.map((s,i)=>{
                const val=m.fmt(s.data[m.key]);
                return `<td class="${i===0?'comp-highlight':''} ${i===bi&&val!=='N/A'?'comp-best':''}">${val}${i===bi&&val!=='N/A'?' üèÜ':''}</td>`;
              }).join('')}
            </tr>`;
          }).join('')}
        </tbody>
      </table></div>
      <div style="font-size:10px;color:#9ca3af;margin-top:6px">üèÜ best among compared ¬∑ ‚òÖ = your stock</div>`;

    // ‚îÄ‚îÄ Commentary ‚îÄ‚îÄ
    const commentaryHtml=generateCommentary(ticker,ov,compData);

    const fmtCap=c=>c>=1e12?'$'+(c/1e12).toFixed(2)+'T':c>=1e9?'$'+(c/1e9).toFixed(1)+'B':'$'+(c/1e6).toFixed(0)+'M';
    const pColor=p=>p>=70?'#22c55e':p>=40?'#f59e0b':'#f87171';
    function secHtml(title,score,max,items,id){
      const pct=(score/max)*100;
      return `<div class="result-section">
        <h3 onclick="toggleSection('${id}')">
          <span>${title}</span>
          <span style="display:flex;align-items:center;gap:8px">
            <span style="color:#9ca3af;font-weight:400">${score}/${max}</span>
            <span class="chevron open" id="ch-${id}">‚ñº</span>
          </span>
        </h3>
        <div class="collapse-content open" id="cc-${id}">
          <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(pct,100)}%;background:${pColor(pct)}"></div></div>
          ${items.map(i=>`<div class="check-item">
            <span class="${i.ok?'check-ok':'check-no'}">${i.ok?'‚úì':'‚úó'}</span>
            <span>${i.text}</span>
          </div>`).join('')}
        </div>
      </div>`;
    }

    const safeName=companyName.replace(/'/g,"\\'").replace(/"/g,'\\"');

    setStatus(`‚úÖ ${companyName} ‚Äî complete`,'#86efac');

    results.innerHTML=`
      <!-- Company Header with Current Price -->
      <div class="company-header" style="margin-top:16px">
        <div class="price-row">
          <div>
            <div style="font-size:20px;font-weight:800;color:#1f2937">${ticker}</div>
            <div style="font-size:13px;color:#374151;font-weight:600;margin-top:2px">${companyName}</div>
            <div style="font-size:11px;color:#9ca3af;margin-top:2px">${sector2}${industry?' ¬∑ '+industry:''}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:11px;color:#9ca3af">52W Range</div>
            <div style="font-size:12px;font-weight:700;color:#1f2937">$${week52Low.toFixed(0)} ‚Äì $${week52High.toFixed(0)}</div>
            ${beta>0?`<div style="font-size:11px;color:#9ca3af;margin-top:2px">Beta: ${beta.toFixed(2)}</div>`:''}
          </div>
        </div>
        <!-- Price vs Target -->
        <div style="display:flex;gap:10px;margin-top:14px">
          <div style="flex:1;background:#f8fafc;border-radius:12px;padding:12px;text-align:center">
            <div style="font-size:10px;font-weight:700;color:#9ca3af;text-transform:uppercase;margin-bottom:4px">Est. Current Price</div>
            <div style="font-size:20px;font-weight:900;color:#1f2937">$${estPrice>0?estPrice.toFixed(2):'N/A'}</div>
            <div style="font-size:10px;color:#6b7280;margin-top:2px">Based on P/B √ó Book Value</div>
          </div>
          <div style="flex:1;background:#f0fdf4;border-radius:12px;padding:12px;text-align:center;border:1px solid #bbf7d0">
            <div style="font-size:10px;font-weight:700;color:#16a34a;text-transform:uppercase;margin-bottom:4px">üéØ Analyst Target</div>
            <div style="font-size:20px;font-weight:900;color:#16a34a">$${analystTgt>0?analystTgt.toFixed(2):'N/A'}</div>
            <div style="font-size:10px;color:#6b7280;margin-top:2px">${analystTgt>0&&estPrice>0?`${((analystTgt-estPrice)/estPrice*100).toFixed(1)}% upside`:'Wall St. consensus'}</div>
          </div>
        </div>
        ${iv>0?`<div style="background:#fffbeb;border-radius:12px;padding:10px;margin-top:8px;text-align:center;border:1px solid #fde68a">
          <span style="font-size:11px;color:#92400e;font-weight:700">üìê DCF Intrinsic Value: </span>
          <span style="font-size:16px;font-weight:900;color:#92400e">$${iv.toFixed(2)}</span>
          ${mos!==null?`<span style="font-size:12px;font-weight:700;color:${mos>=30?'#16a34a':mos>=0?'#d97706':'#dc2626'};margin-left:8px">${mos.toFixed(1)}% margin of safety</span>`:''}
        </div>`:''}
      </div>

      <!-- Verdict -->
      <div class="verdict-card" style="background:${verdict.bg};border:1px solid ${verdict.border}">
        <div style="font-size:52px;margin-bottom:8px">${verdict.emoji}</div>
        <div style="font-size:28px;font-weight:900;color:${verdict.color};margin-bottom:4px">${verdict.label}</div>
        <div style="font-size:13px;color:#6b7280;margin-bottom:16px">${companyName}</div>
        <div class="score-box">
          <span style="font-size:28px;font-weight:900;color:#1f2937">${total}</span>
          <span style="font-size:14px;color:#9ca3af">/${maxScore} pts</span>
        </div>
        ${divYield>0?`<div style="margin-top:8px;font-size:12px;color:#6b7280">Dividend: <strong style="color:#16a34a">${divYield.toFixed(2)}%</strong></div>`:''}
      </div>

      <!-- Key Metrics -->
      <div class="metrics-grid">
        <div class="metric-box"><div class="mlabel">EPS (TTM)</div><div class="mvalue" style="color:${eps>0?'#16a34a':'#dc2626'}">$${eps.toFixed(2)}</div><div class="msub">Earnings/share</div></div>
        <div class="metric-box"><div class="mlabel">PEG Ratio</div><div class="mvalue" style="color:${pegOk?'#16a34a':pegRatio>2?'#dc2626':'#d97706'}">${pegRatio>0?pegRatio.toFixed(2):'N/A'}</div><div class="msub">Under 1.0 = undervalued</div></div>
        <div class="metric-box"><div class="mlabel">P/E Ratio</div><div class="mvalue" style="color:${peOk?'#16a34a':'#d97706'}">${peRatio>0?peRatio.toFixed(1):'N/A'}</div><div class="msub">Target: under 25</div></div>
        <div class="metric-box"><div class="mlabel">ROE</div><div class="mvalue" style="color:${roe>=15?'#16a34a':'#dc2626'}">${roe.toFixed(1)}%</div><div class="msub">Target: ‚â•15%</div></div>
        <div class="metric-box"><div class="mlabel">Net Margin</div><div class="mvalue" style="color:${netMargin>=10?'#16a34a':'#dc2626'}">${netMargin.toFixed(1)}%</div><div class="msub">Target: ‚â•10%</div></div>
        <div class="metric-box"><div class="mlabel">Market Cap</div><div class="mvalue" style="font-size:14px">${fmtCap(mktCap)}</div><div class="msub">${sector2||'‚Äî'}</div></div>
      </div>

      ${secHtml('üìä Intrinsic Value (DCF)',dcfScore,26,dcfItems,'dcf')}
      ${secHtml('üíπ EPS & Valuation',epsScore,13,epsItems,'eps')}
      ${secHtml('üè∞ Economic Moat',moatScore,24,moatItems,'moat')}
      ${secHtml('üí∞ Debt & Financial Health',debtScore,24,debtItems,'debt')}
      ${secHtml('üîë Owner Earnings',oeScore,24,oeItems,'oe')}

      <!-- Editable DCF Calculator -->
      <div class="result-section">
        <h3 onclick="toggleSection('dcfcalc')">
          <span>üßÆ DCF Calculator (Editable)</span>
          <span class="chevron open" id="ch-dcfcalc">‚ñº</span>
        </h3>
        <div class="collapse-content open" id="cc-dcfcalc">
          <div style="font-size:12px;color:#6b7280;margin-bottom:10px">Adjust any parameter and tap Recalculate to see how intrinsic value changes.</div>
          <div class="dcf-input-grid">
            <div class="dcf-input-box">
              <label>EPS ($)</label>
              <input type="number" id="dcf_eps" value="${eps.toFixed(2)}" step="0.01"/>
            </div>
            <div class="dcf-input-box">
              <label>Growth Rate (%)</label>
              <input type="number" id="dcf_growth" value="${(g*100).toFixed(1)}" step="0.5"/>
            </div>
            <div class="dcf-input-box">
              <label>Discount Rate (%)</label>
              <input type="number" id="dcf_disc" value="10" step="0.5"/>
            </div>
            <div class="dcf-input-box">
              <label>Terminal Growth (%)</label>
              <input type="number" id="dcf_term" value="3" step="0.5"/>
            </div>
            <div class="dcf-input-box">
              <label>Years</label>
              <input type="number" id="dcf_yrs" value="10" min="5" max="20"/>
            </div>
            <div class="dcf-input-box">
              <label>Current Price ($)</label>
              <input type="number" id="dcf_price" value="${estPrice>0?estPrice.toFixed(2):''}" step="0.01"/>
            </div>
          </div>
          <button class="dcf-calc-btn" onclick="recalcDCF()">üîÑ Recalculate Intrinsic Value</button>
          <div id="dcf-result-area"></div>
        </div>
      </div>

      <!-- Competitor Comparison -->
      <div class="result-section">
        <h3 onclick="toggleSection('comp')">
          <span>üìä vs ${compData.map(c=>c.ticker).join(', ')}</span>
          <span class="chevron open" id="ch-comp">‚ñº</span>
        </h3>
        <div class="collapse-content open" id="cc-comp">
          ${compTableHtml}
        </div>
      </div>

      <!-- News -->
      <div class="result-section">
        <h3 onclick="toggleSection('news')">
          <span>üì∞ Latest News ‚Äî ${ticker}</span>
          <span class="chevron open" id="ch-news">‚ñº</span>
        </h3>
        <div class="collapse-content open" id="cc-news">
          ${newsHtml}
        </div>
      </div>

      <!-- AI Commentary -->
      <div class="result-section">
        <h3 onclick="toggleSection('commentary')">
          <span>ü§ñ AI Analysis & Commentary</span>
          <span class="chevron open" id="ch-commentary">‚ñº</span>
        </h3>
        <div class="collapse-content open" id="cc-commentary">
          ${commentaryHtml}
        </div>
      </div>

      <div class="quote-box">
        <p>"It's far better to buy a wonderful company at a fair price than a fair company at a wonderful price."</p>
        <span>‚Äî Warren Buffett</span>
      </div>

      <button class="btn-save" onclick="saveStock('${ticker}','${safeName}',${total},${iv.toFixed(2)},${mos!==null?mos.toFixed(1):0},'${verdict.label}','${verdict.color}','${verdict.emoji}',${maxScore})">
        üíæ Save to Watchlist
      </button>
      <button class="btn-reset" onclick="resetApp()">üîÑ Analyze Another Stock</button>
      <p class="disclaimer">‚ö†Ô∏è Educational use only. Not financial advice. Data: Alpha Vantage. Always do your own research before investing.</p>
    `;

    // Run default DCF calc
    recalcDCF();

  }catch(err){
    setStatus('‚ùå '+err.message.substring(0,50),'#fca5a5');
    results.innerHTML=`<div class="error-box" style="margin-top:16px">
      <h3>‚ùå Error</h3>
      <p style="margin-bottom:12px">${err.message}</p>
      <p style="font-size:12px">Examples: AAPL ¬∑ INTC ¬∑ MSFT ¬∑ KO ¬∑ JNJ ¬∑ WMT</p>
      <button onclick="analyzeStock()" style="margin-top:12px;padding:10px 24px;background:#dc2626;color:white;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer">üîÑ Retry</button>
    </div>`;
  }
}

function renderWatchlist(){
  const el=document.getElementById('watchlistView');
  if(!watchlist.length){
    el.innerHTML=`<div class="welcome">
      <div style="font-size:48px;margin-bottom:12px">üìã</div>
      <div style="font-size:16px;font-weight:700;color:#374151;margin-bottom:6px">Watchlist Empty</div>
      <div style="font-size:13px;color:#6b7280">Analyze a stock and tap "Save to Watchlist"</div>
    </div>`;
    return;
  }
  el.innerHTML=`<div class="watchlist-card">
    <div style="font-size:15px;font-weight:700;color:#374151;margin-bottom:12px">üìã My Watchlist (${watchlist.length})</div>
    ${watchlist.map((s,i)=>`<div class="watchlist-item">
      <div style="flex:1;cursor:pointer" onclick="loadFromWatchlist('${s.ticker}')">
        <div style="font-size:14px;font-weight:700;color:#1f2937">${s.emoji} ${s.ticker} <span style="font-weight:400;color:#6b7280;font-size:12px">${s.name.length>18?s.name.substring(0,18)+'...':s.name}</span></div>
        <div style="font-size:11px;color:#9ca3af;margin-top:2px">${s.date} ¬∑ IV $${s.iv}</div>
      </div>
      <div style="text-align:right;margin-right:10px">
        <div style="font-size:16px;font-weight:900;color:${s.color}">${s.score}/${s.max}</div>
        <div style="font-size:11px;color:${s.color};font-weight:600">${s.label}</div>
      </div>
      <button onclick="removeFromWatchlist(${i})" style="background:none;border:none;color:#f87171;font-size:18px;cursor:pointer;padding:4px">‚úï</button>
    </div>`).join('')}
  </div>
  <p class="disclaimer">Tap any stock to re-analyze it</p>`;
}

function loadFromWatchlist(ticker){
  document.getElementById('tickerInput').value=ticker;
  showPage('analyze');
  analyzeStock();
}

function removeFromWatchlist(i){
  watchlist.splice(i,1);
  localStorage.setItem('buffett_wl',JSON.stringify(watchlist));
  renderWatchlist();
}

function saveStock(ticker,name,score,iv,mos,label,color,emoji,max){
  try{
    const entry={ticker,name,score,iv,mos,label,color,emoji,max,date:new Date().toLocaleDateString()};
    watchlist=[entry,...watchlist.filter(s=>s.ticker!==ticker)].slice(0,20);
    localStorage.setItem('buffett_wl',JSON.stringify(watchlist));
    alert(`‚úÖ ${ticker} saved!`);
  }catch(e){alert('Could not save');}
}

function resetApp(){
  document.getElementById('tickerInput').value='';
  setStatus('üü¢ Ready','#93c5fd');
  document.getElementById('results').innerHTML=`<div class="welcome">
    <div style="font-size:56px;margin-bottom:12px">üìà</div>
    <div style="font-size:17px;font-weight:700;color:#374151;margin-bottom:8px">Ready to Analyze</div>
    <div style="font-size:13px;color:#6b7280;line-height:2.2"><strong>AAPL</strong> ¬∑ <strong>INTC</strong> ¬∑ <strong>MSFT</strong> ¬∑ <strong>KO</strong> ¬∑ <strong>JNJ</strong></div>
  </div>`;
}
</script>
</body>
</html>
